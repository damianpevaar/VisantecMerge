<section class="tickets-layout" *ngIf="!loadingTickets; else loadingState">
  <aside class="tickets-panel">
    <header class="filters">
      <h2>Tickets</h2>
      <button mat-flat-button color="primary" type="button" (click)="openCreateDialog()">
        <span class="material-symbols-rounded">add</span>
        Nuevo ticket
      </button>
    </header>

    <form [formGroup]="filtersForm" class="filters-form">
      <mat-form-field appearance="outline" class="full">
        <mat-label>Buscar</mat-label>
        <input matInput placeholder="Número, asunto, correo" formControlName="search">
      </mat-form-field>

      <div class="filters-grid">
        <mat-form-field appearance="outline">
          <mat-label>Estado</mat-label>
          <mat-select formControlName="status">
            <mat-option [value]="null">Todos</mat-option>
            <mat-option *ngFor="let status of statusOptions" [value]="status">
              {{ statusLabels[status] }}
            </mat-option>
          </mat-select>
        </mat-form-field>

        <mat-form-field appearance="outline">
          <mat-label>Prioridad</mat-label>
          <mat-select formControlName="priority">
            <mat-option [value]="null">Todas</mat-option>
            <mat-option *ngFor="let priority of priorityOptions" [value]="priority">
              {{ priorityLabels[priority] }}
            </mat-option>
          </mat-select>
        </mat-form-field>

        <mat-form-field appearance="outline">
          <mat-label>Origen</mat-label>
          <mat-select formControlName="origin">
            <mat-option [value]="null">Todos</mat-option>
            <mat-option *ngFor="let origin of originOptions" [value]="origin">
              {{ originLabels[origin] }}
            </mat-option>
          </mat-select>
        </mat-form-field>

        <mat-form-field appearance="outline">
          <mat-label>Cliente</mat-label>
          <mat-select formControlName="clientOrganizationId">
            <mat-option [value]="null">Todos</mat-option>
            <mat-option *ngFor="let org of organizations" [value]="org.id">
              {{ org.name }}
            </mat-option>
          </mat-select>
        </mat-form-field>
      </div>

      <div class="filters-grid">
        <mat-form-field appearance="outline">
          <mat-label>Desde</mat-label>
          <input matInput type="date" formControlName="from">
        </mat-form-field>

        <mat-form-field appearance="outline">
          <mat-label>Hasta</mat-label>
          <input matInput type="date" formControlName="to">
        </mat-form-field>
      </div>
    </form>

    <div class="ticket-list" *ngIf="tickets.length; else emptyState">
      <article
        class="ticket-item"
        *ngFor="let ticket of tickets; trackBy: trackByTicketId"
        [class.selected]="ticket.id === selectedTicket?.id"
        (click)="selectTicket(ticket)">
        <div class="item-header">
          <span class="ticket-number">#{{ ticket.ticketNumber }}</span>
          <span class="status">{{ statusChip(ticket) }}</span>
        </div>
        <h3>{{ ticket.subject }}</h3>
        <p>{{ ticket.requestedByEmail }}<span *ngIf="ticket.requestedByName"> - {{ ticket.requestedByName }}</span></p>
        <footer>
          <span class="badge priority">{{ priorityChip(ticket) }}</span>
          <span class="badge origin">{{ originChip(ticket) }}</span>
          <span class="date">{{ ticket.openedAt | date:'short' }}</span>
        </footer>
      </article>
    </div>
  </aside>

  <main class="ticket-detail" *ngIf="selectedTicket; else detailEmpty">
    <header class="detail-header">
      <div>
        <h2>{{ selectedTicket.subject }}</h2>
        <div class="chips">
          <span class="chip status">{{ statusChip(selectedTicket) }}</span>
          <span class="chip priority">{{ priorityChip(selectedTicket) }}</span>
          <span class="chip origin">{{ originChip(selectedTicket) }}</span>
        </div>
      </div>
      <div class="meta">
        <span>Ticket #{{ selectedTicket.ticketNumber }}</span>
        <span>Creado: {{ selectedTicket.openedAt | date:'short' }}</span>
        <span *ngIf="selectedTicket.slaDueAt">SLA: {{ selectedTicket.slaDueAt | date:'short' }}</span>
        <span *ngIf="selectedTicket.managedMailbox">Buzon: {{ selectedTicket.managedMailbox.displayName || selectedTicket.managedMailbox.address }}</span>
      </div>
    </header>

    <section class="assign">
      <mat-form-field appearance="outline">
        <mat-label>Asignado a</mat-label>
        <input type="text" matInput [matAutocomplete]="auto" [formControl]="assignControl">
        <mat-autocomplete #auto="matAutocomplete" (optionSelected)="assignTicket()">
          <mat-option *ngFor="let user of assignableUsers" [value]="user.id">
            {{ user.userName }} - {{ user.email }}
          </mat-option>
        </mat-autocomplete>
      </mat-form-field>
      <button mat-button color="primary" type="button" (click)="assignTicket()" [disabled]="!assignControl.value">
        Guardar asignación
      </button>
    </section>

    <form [formGroup]="updateForm" class="update-form" (ngSubmit)="submitUpdate()">
      <div class="grid">
        <mat-form-field appearance="outline">
          <mat-label>Asunto</mat-label>
          <input matInput formControlName="subject">
        </mat-form-field>

        <mat-form-field appearance="outline">
          <mat-label>Estado</mat-label>
          <mat-select formControlName="status">
            <mat-option *ngFor="let status of statusOptions" [value]="status">
              {{ statusLabels[status] }}
            </mat-option>
          </mat-select>
        </mat-form-field>

        <mat-form-field appearance="outline">
          <mat-label>Prioridad</mat-label>
          <mat-select formControlName="priority">
            <mat-option *ngFor="let priority of priorityOptions" [value]="priority">
              {{ priorityLabels[priority] }}
            </mat-option>
          </mat-select>
        </mat-form-field>

        <mat-form-field appearance="outline">
          <mat-label>Cliente</mat-label>
          <mat-select formControlName="clientOrganizationId">
            <mat-option [value]="null">Sin cliente</mat-option>
            <mat-option *ngFor="let org of organizations" [value]="org.id">
              {{ org.name }}
            </mat-option>
          </mat-select>
        </mat-form-field>
      </div>

      <mat-form-field appearance="outline" class="full">
        <mat-label>Descripción</mat-label>
        <textarea matInput rows="3" formControlName="description"></textarea>
      </mat-form-field>

      <mat-form-field appearance="outline" class="full">
        <mat-label>Resumen de resolución</mat-label>
        <textarea matInput rows="2" formControlName="resolutionSummary"></textarea>
      </mat-form-field>

      <div class="form-actions">
        <button mat-flat-button color="primary" type="submit" [disabled]="updateForm.invalid || updatingTicket">
          Guardar cambios
        </button>
      </div>
    </form>

    <section class="attachments" *ngIf="selectedTicket.attachments?.length">
      <h3>Adjuntos iniciales</h3>
      <ul>
        <li *ngFor="let attachment of selectedTicket.attachments">
          <span class="material-symbols-rounded">attachment</span>
          <span class="name">{{ attachment.fileName }}</span>
          <button mat-button type="button" (click)="downloadAttachment(attachment)">Descargar</button>
        </li>
      </ul>
    </section>

    <section class="messages">
      <header>
        <h3>Conversación</h3>
      </header>
      <div class="message-timeline">
        <article class="message" *ngFor="let message of selectedTicket.messages">
          <header>
            <span class="direction">{{ message.direction }}</span>
            <span class="timestamp">{{ message.sentAt | date:'short' }}</span>
            <span *ngIf="message.externalAuthor"> - {{ message.externalAuthor }}</span>
            <span *ngIf="message.authorUserId"> - {{ message.authorUserId }}</span>
          </header>
          <p class="body">{{ message.body }}</p>
          <ul class="message-attachments" *ngIf="message.attachments?.length">
            <li *ngFor="let attachment of message.attachments">
              <span class="material-symbols-rounded">attach_file</span>
              <button mat-button type="button" (click)="downloadAttachment(attachment)">
                {{ attachment.fileName }}
              </button>
            </li>
          </ul>
        </article>
      </div>
    </section>

    <section class="history" *ngIf="selectedTicket.statusHistory?.length">
      <header>
        <h3>Historial de estado</h3>
      </header>
      <ul>
        <li *ngFor="let change of selectedTicket.statusHistory">
          <span class="material-symbols-rounded">history</span>
          <div>
            <p>{{ statusLabels[change.fromStatus] }} ? {{ statusLabels[change.toStatus] }}</p>
            <small>{{ change.changedAt | date:'short' }} - {{ change.changedByUserId || 'Sistema' }}</small>
            <p *ngIf="change.notes" class="notes">{{ change.notes }}</p>
          </div>
        </li>
      </ul>
    </section>

    <section class="reply">
      <h3>Responder</h3>
      <app-ticket-reply-form (submitReply)="handleReply($event)" [disabled]="replying"></app-ticket-reply-form>
    </section>
  </main>
</section>

<ng-template #loadingState>
  <div class="loading-state">
    <mat-progress-spinner mode="indeterminate"></mat-progress-spinner>
    <p>Cargando tickets...</p>
  </div>
</ng-template>

<ng-template #emptyState>
  <div class="empty">
    <p>No hay tickets que coincidan con el filtro actual.</p>
  </div>
</ng-template>

<ng-template #detailEmpty>
  <div class="empty detail">
    <p>Selecciona un ticket para ver su detalle.</p>
  </div>
</ng-template>
